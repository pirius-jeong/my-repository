# 12장. Exception Handling and Recovery(예외 처리 및 복구)

## 12.1 패턴 개요

- **정의**: 에이전트가 **오류 감지·처리·복구**를 통해 안정적 운영 유지하는 패턴이다.
- **왜 필요?** 실제 환경 불확실성(오류·장애) → 중단 방지, **견고성·회복력** 확보.
- **반사 연계**: 실패 분석 → 개선 프롬프트 → 재시도.

### 3단계 구조

| 단계 | 내용 | 예시 |
|------|------|------|
| **오류 감지** | 문제 식별(모니터링) | 도구 출력 오류·API 404/500·타임아웃 |
| **오류 처리** | 즉시 대응 | 로깅·재시도·폴백·저하·알림 |
| **회복** | 안정 상태 복귀 | 롤백·진단·자체 수정·에스컬레이션 |

---

## 12.2 실제 응용 사례

| 시나리오 | 오류 예 | 처리·복구 |
|----------|---------|-----------|
| **챗봇** | DB 다운 | 재시도·에스컬레이션 |
| **트레이딩 봇** | 자금 부족 | 기록·전략 조정 |
| **스마트 홈** | 네트워크 오류 | 재시도·수동 제안 |
| **데이터 처리** | 손상 파일 | 건너뛰기·보고 |
| **웹 스크래핑** | CAPTCHA·404 | 프록시·보고 |
| **로봇공학** | 픽업 실패 | 재조정·대체 부품 |

---

## 12.3 구현: Google ADK 예제

- **SequentialAgent 폴백 구조**:
```python
primary_handler = Agent(  # 1단계: 정확 위치 도구
    tools=[get_precise_location_info]
)

fallback_handler = Agent(  # 2단계: 상태 확인 후 일반 도구
    instruction="state['primary_failed'] 확인 후 get_general_area_info 사용",
    tools=[get_general_area_info]
)

response_agent = Agent(  # 3단계: 결과 제시
    instruction="state['location_result'] 기반 응답"
)

robust_agent = SequentialAgent(
    sub_agents=[primary, fallback, response]
)
```

- **흐름**: 1단계 실패 → 상태 플래그 → 2단계 폴백 → 최종 응답.

---

## 12.4 전략 상세

### 12.4.1 오류 감지

- **지표**: 출력 형식 불일치·HTTP 오류·타임아웃·무의미 응답.
- **모니터링**: 별도 에이전트·센서 피드백.


### 12.4.2 오류 처리

- **로깅**: 상세 기록(디버깅용).
- **재시도(Retry)**: 지수 백오프(매개변수 조정).
- **폴백(Fallback)**: 대체 도구·방법.
- **우아한 저하(Graceful Degradation)**: 부분 기능 유지.
- **알림(Alerting)**: 인간·다른 에이전트.


### 12.4.3 회복

- **상태 롤백**: 변경 취소.
- **진단**: 원인 분석.
- **자체 수정**: 계획·프롬프트 재조정.
- **에스컬레이션**: 상위 시스템·인간 위임.

---

## 12.5 한눈에 보기

- **무엇**: **오류 생애주기 관리**(감지→처리→복구).
- **왜**: 예측 불가능 환경 → 안정성·신뢰성 필수.
- **어떻게**: ADK SequentialAgent 폴백 + 로깅·재시도·자체 수정.
- **언제**: 실제 배포(챗봇·트레이딩·IoT 등).

---

## 12.6 핵심 정리

- 예외 처리·복구는 **에이전트의 실전 배포 가능성** 결정짓는다.
- 3단계(감지·처리·회복) + 폴백 구조로 중단 최소화.
- 반사·계획 패턴과 결합 시 완벽한 회복력.
